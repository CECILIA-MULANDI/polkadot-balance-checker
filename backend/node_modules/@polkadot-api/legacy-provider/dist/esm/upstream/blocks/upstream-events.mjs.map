{"version":3,"file":"upstream-events.mjs","sources":["../../../../src/upstream/blocks/upstream-events.ts"],"sourcesContent":["import { DecentHeader, ShittyHeader } from \"@/types\"\nimport { getFromShittyHeader } from \"@/utils/fromShittyHeader\"\nimport { getHasherFromBlock } from \"@/utils/get-hasher-from-block\"\nimport { shareLatest } from \"@/utils/share-latest\"\nimport { withLatestFromBp } from \"@/utils/with-latest-from-bp\"\nimport { ClientRequest } from \"@polkadot-api/raw-client\"\nimport { HexString } from \"@polkadot-api/substrate-bindings\"\nimport { noop } from \"@polkadot-api/utils\"\nimport { concat, map, mergeMap, Observable, of, pipe, Subject } from \"rxjs\"\n\nexport const getUpstreamEvents = (\n  request: ClientRequest<any, any>,\n  request$: <Args extends Array<any>, Payload>(\n    method: string,\n    params: Args,\n  ) => Observable<Payload>,\n) => {\n  const firstFinHeader$ = new Subject<ShittyHeader>()\n  const hasher$ = firstFinHeader$.pipe(\n    mergeMap((h) =>\n      request$<[number | string], HexString>(\"chain_getBlockHash\", [\n        h.number,\n      ]).pipe(map(getHasherFromBlock(h))),\n    ),\n    shareLatest,\n  )\n  const fromShittyHeader$ = hasher$.pipe(map(getFromShittyHeader), shareLatest)\n  const toNiceHeader = pipe(\n    withLatestFromBp<\n      (x: ShittyHeader) => ReturnType<ReturnType<typeof getFromShittyHeader>>,\n      ShittyHeader\n    >(fromShittyHeader$),\n    map(([fromShittyHeader, shitHeader]) => fromShittyHeader(shitHeader)),\n  )\n\n  const getHeaders$ = (\n    startMethod: string,\n    stopMethod: string,\n    isFin = false,\n  ): Observable<DecentHeader> =>\n    new Observable<ShittyHeader>((observer) => {\n      const onError = (e: any) => {\n        observer.error(e)\n      }\n\n      let stop: (() => void) | null = null\n      let isFirstFin = isFin\n      ;(request as ClientRequest<string, ShittyHeader>)(startMethod, [], {\n        onSuccess: (subId, followSub) => {\n          const done = followSub(subId, {\n            next: (v) => {\n              if (isFirstFin) {\n                isFirstFin = false\n                firstFinHeader$.next(v)\n                firstFinHeader$.complete()\n              }\n              observer.next(v)\n            },\n            error: onError,\n          })\n          const unsubscribe = () => {\n            done()\n            try {\n              request(stopMethod, [subId], {\n                onError: noop,\n                onSuccess: noop,\n              })\n            } catch {}\n          }\n          if (stop !== null) unsubscribe()\n          else stop = unsubscribe\n        },\n        onError,\n      })\n\n      return () => {\n        stop?.()\n        stop = noop\n      }\n    }).pipe(toNiceHeader)\n\n  const allHeads$ = getHeaders$(\n    \"chain_subscribeAllHeads\",\n    \"chain_unsubscribeAllHeads\",\n  )\n\n  const finalized$ = getHeaders$(\n    \"chain_subscribeFinalizedHeads\",\n    \"chain_unsubscribeFinalizedHeads\",\n    true,\n  )\n\n  const getHeader$ = (hash: string) =>\n    request$<[string], ShittyHeader>(\"chain_getHeader\", [hash]).pipe(\n      toNiceHeader,\n    )\n\n  const getRecursiveHeader = (hash: string): Observable<DecentHeader> =>\n    getHeader$(hash).pipe(\n      mergeMap((header) =>\n        concat(of(header), getRecursiveHeader(header.parent)),\n      ),\n    )\n\n  return {\n    allHeads$,\n    finalized$,\n    hasher$,\n    getRecursiveHeader,\n    getHeader$,\n  }\n}\n\nexport type UpstreamEvents = ReturnType<typeof getUpstreamEvents>\n"],"names":[],"mappings":"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"}